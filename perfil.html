<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Perfil do Usu√°rio</title>
    <link rel="stylesheet" href="css/estilos.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDul81cb5or7oR8HCs5I_Vw-SHm-ORHshI",
            authDomain: "teste-2067f.firebaseapp.com",
            projectId: "teste-2067f",
            storageBucket: "teste-2067f.appspot.com",
            messagingSenderId: "160483034987",
            appId: "1:160483034987:web:944eb621b02efea11b2e2e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('abrirFormulario');
            const profileInfoContainer = document.getElementById('profileInfo');

            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    Swal.fire("Voc√™ precisa estar logado para acessar o perfil.");
                    btn.disabled = true;
                    return;
                }

                const uid = user.uid;
                const userRef = doc(db, "usuarios", uid);
                getDoc(userRef).then((docSnap) => {
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        const isAdmin = userData.isAdmin || false; // Verifica se o usu√°rio √© administrador
                        
                        // Exibe o perfil do usu√°rio
                        profileInfoContainer.innerHTML = `
                            <div class="profile-card">
                                <h3>Dados Cadastrados</h3>
                                <p><strong>Nome:</strong> ${userData.nome}</p>
                                <p><strong>Idade:</strong> ${userData.idade}</p>
                                <p><strong>Sexo:</strong> ${userData.sexo}</p>
                                <p><strong>Rua:</strong> ${userData.rua}</p>
                                <p><strong>Bairro:</strong> ${userData.bairro}</p>

                                <!-- Informa√ß√µes de doa√ß√µes e datas -->
                                <div class="donation-info">
                                    <p><i class="heart-icon">‚ù§Ô∏è</i> <strong>Doa√ß√µes:</strong> ${userData.doacoes || 0}</p>
                                    <p><i class="calendar-icon">üìÖ</i> <strong>√öltima Doa√ß√£o:</strong> ${userData.ultimaDoacao || 'N√£o registrada'}</p>
                                    <p><i class="calendar-icon">‚è≥</i> <strong>Pr√≥xima Doa√ß√£o:</strong> ${userData.proximaDoacao || 'N√£o definida'}</p>
                                </div>

                                ${isAdmin ? '<button id="editarDoacao" class="btn-editar">Editar Doa√ß√µes</button>' : ''}
                            </div>
                        `;

                        // Se o usu√°rio for administrador, permitir a edi√ß√£o
                        if (isAdmin) {
                            document.getElementById('editarDoacao').addEventListener('click', () => {
                                Swal.fire({
                                    title: 'Editar Doa√ß√µes',
                                    width: 600,
                                    html: `
                                        <div class="form-container">
                                            <input type="number" id="doacoes" placeholder="Quantidade de Doa√ß√µes" class="form-field" value="${userData.doacoes || ''}">
                                            <input type="date" id="ultimaDoacao" placeholder="√öltima Doa√ß√£o" class="form-field" value="${userData.ultimaDoacao || ''}">
                                            <input type="date" id="proximaDoacao" placeholder="Pr√≥xima Doa√ß√£o" class="form-field" value="${userData.proximaDoacao || ''}">
                                        </div>
                                    `,
                                    customClass: {
                                        popup: 'popup-form'
                                    },
                                    confirmButtonText: 'Salvar',
                                    focusConfirm: false,
                                    preConfirm: () => {
                                        const doacoes = document.getElementById('doacoes').value.trim();
                                        const ultimaDoacao = document.getElementById('ultimaDoacao').value.trim();
                                        const proximaDoacao = document.getElementById('proximaDoacao').value.trim();

                                        return { doacoes, ultimaDoacao, proximaDoacao };
                                    }
                                }).then(async (result) => {
                                    if (result.isConfirmed) {
                                        try {
                                            const userRef = doc(db, "usuarios", uid);
                                            await setDoc(userRef, {
                                                ...userData,
                                                doacoes: result.value.doacoes,
                                                ultimaDoacao: result.value.ultimaDoacao,
                                                proximaDoacao: result.value.proximaDoacao
                                            }, { merge: true });

                                            Swal.fire('Sucesso!', 'Doa√ß√µes atualizadas com sucesso.', 'success');
                                            profileInfoContainer.innerHTML = `
                                                <div class="profile-card">
                                                    <h3>Dados Atualizados</h3>
                                                    <p><strong>Nome:</strong> ${userData.nome}</p>
                                                    <p><strong>Idade:</strong> ${userData.idade}</p>
                                                    <p><strong>Sexo:</strong> ${userData.sexo}</p>
                                                    <p><strong>Rua:</strong> ${userData.rua}</p>
                                                    <p><strong>Bairro:</strong> ${userData.bairro}</p>
                                                    <div class="donation-info">
                                                        <p><i class="heart-icon">‚ù§Ô∏è</i> <strong>Doa√ß√µes:</strong> ${result.value.doacoes}</p>
                                                        <p><i class="calendar-icon">üìÖ</i> <strong>√öltima Doa√ß√£o:</strong> ${result.value.ultimaDoacao || 'N√£o registrada'}</p>
                                                        <p><i class="calendar-icon">‚è≥</i> <strong>Pr√≥xima Doa√ß√£o:</strong> ${result.value.proximaDoacao || 'N√£o definida'}</p>
                                                    </div>
                                                </div>
                                            `;
                                        } catch (err) {
                                            console.error("Erro ao salvar dados:", err);
                                            Swal.fire('Erro', 'N√£o foi poss√≠vel salvar os dados.', 'error');
                                        }
                                    }
                                });
                            });
                        }
                    } else {
                        profileInfoContainer.innerHTML = `
                            <div class="profile-card">
                                <h3>Nenhum dado encontrado</h3>
                                <p>Voc√™ ainda n√£o completou o seu cadastro. Por favor, preencha os dados abaixo.</p>
                            </div>
                        `;
                    }
                }).catch((err) => {
                    console.error("Erro ao recuperar dados:", err);
                    profileInfoContainer.innerHTML = `<p>Erro ao carregar os dados.</p>`;
                });

                btn.addEventListener('click', () => {
                    Swal.fire({
                        title: 'Preencha seus dados',
                        width: 600,
                        html: `
                            <div class="form-container">
                                <input type="text" id="nome" placeholder="Nome completo" class="form-field" required>
                                <input type="number" id="idade" placeholder="Idade" class="form-field" required>
                                <select id="sexo" class="form-field" required>
                                    <option value="">Selecione o sexo</option>
                                    <option value="Feminino">Feminino</option>
                                    <option value="Masculino">Masculino</option>
                                    <option value="Outro">Outro</option>
                                </select>
                                <input type="text" id="rua" placeholder="Rua" class="form-field" required>
                                <input type="text" id="bairro" placeholder="Bairro" class="form-field" required>
                            </div>
                        `,
                        customClass: {
                            popup: 'popup-form'
                        },
                        confirmButtonText: 'Salvar',
                        focusConfirm: false,
                        preConfirm: () => {
                            const nome = document.getElementById('nome').value.trim();
                            const idade = document.getElementById('idade').value.trim();
                            const sexo = document.getElementById('sexo').value.trim();
                            const rua = document.getElementById('rua').value.trim();
                            const bairro = document.getElementById('bairro').value.trim();

                            if (!nome || !idade || !sexo || !rua || !bairro) {
                                Swal.showValidationMessage('Preencha todos os campos!');
                                return false;
                            }

                            return { nome, idade, sexo, rua, bairro };
                        }
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            try {
                                const uid = auth.currentUser.uid;
                                await setDoc(doc(db, "usuarios", uid), result.value);
                                Swal.fire('Sucesso!', 'Dados salvos com sucesso.', 'success');
                                profileInfoContainer.innerHTML = `
                                    <div class="profile-card">
                                        <h3>Dados Atualizados</h3>
                                        <p><strong>Nome:</strong> ${result.value.nome}</p>
                                        <p><strong>Idade:</strong> ${result.value.idade}</p>
                                        <p><strong>Sexo:</strong> ${result.value.sexo}</p>
                                        <p><strong>Rua:</strong> ${result.value.rua}</p>
                                        <p><strong>Bairro:</strong> ${result.value.bairro}</p>
                                    </div>
                                `;
                            } catch (err) {
                                console.error("Erro ao salvar dados:", err);
                                Swal.fire('Erro', 'N√£o foi poss√≠vel salvar os dados.', 'error');
                            }
                        }
                    });
                });
            });
        });
    </script>

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f4f6f9;
            margin: 0;
            padding: 0;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-top: 50px;
            font-size: 36px;
            font-weight: bold;
        }

        .botao-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        .perfil-btn {
            padding: 15px 30px;
            background-color: #007bff;
            color: white;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.2);
        }

        .perfil-btn:hover {
            background-color: #0056b3;
            transform: translateY(-3px);
        }

        .profile-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            text-align: left;
        }

        .profile-card h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #444;
        }

        .profile-card p {
            font-size: 18px;
            margin: 10px 0;
            line-height: 1.6;
        }

        .donation-info p {
            font-size: 18px;
            margin: 5px 0;
            display: flex;
            align-items: center;
        }

        .donation-info i {
            margin-right: 10px;
        }

        .form-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-field {
            padding: 15px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            transition: border-color 0.3s ease;
        }

        .form-field:focus {
            border-color: #007bff;
            outline: none;
        }

        .popup-form {
            border-radius: 12px !important;
        }

        .btn-editar {
            background-color: #ffc107;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin-top: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-editar:hover {
            background-color: #e0a800;
            transform: translateY(-3px);
        }
    </style>
</head>

<body>
    <header class="header-moderno">
        <div class="logo">
            <img src="img/icone.png" alt="Logo">
            <span>Sangue Solid√°rio</span>
        </div>

        <nav class="menu-centralizado">
            <a href="#conteudos">In√≠cio</a>
            <a href="#solicite-demo" class="cta-button">Campanhas Ativas</a>
        </nav>
    </header>

    <h1>Perfil do Usu√°rio</h1>
    <div class="botao-container">
        <button class="perfil-btn" id="abrirFormulario">Seus dados j√° est√£o cadastrados?</button>
    </div>
    <div id="profileInfo"></div>
</body>
<script type="module" src="js/auth-status.js"></script>
</html>
